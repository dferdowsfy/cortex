name: Daily Proxy Validation Security Tests

on:
  schedule:
    # Run every day at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Which test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - domains
          - api
          - attachments
          - bypass
          - discovery
      proxy_host:
        description: 'Proxy host override'
        required: false
        default: ''
      proxy_port:
        description: 'Proxy port override'
        required: false
        default: ''
      strict_preflight:
        description: 'Fail on preflight warnings'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: proxy-validation-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  REPORTS_DIR: reports
  ARTIFACTS_DIR: artifacts

jobs:
  # -------------------------------------------------------------------------
  # Preflight: validate environment and proxy connectivity
  # -------------------------------------------------------------------------
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    outputs:
      proxy_reachable: ${{ steps.check.outputs.proxy_reachable }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: proxy-test-harness/package.json

      - name: Install harness dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Check proxy connectivity
        id: check
        env:
          PROXY_HOST: ${{ inputs.proxy_host || secrets.PROXY_HOST || '127.0.0.1' }}
          PROXY_PORT: ${{ inputs.proxy_port || secrets.PROXY_PORT || '8080' }}
          PROXY_LOG_URL: ${{ secrets.PROXY_LOG_URL || 'http://localhost:3737/logs' }}
          STRICT_PREFLIGHT: ${{ inputs.strict_preflight || 'true' }}
        run: |
          node proxy-test-harness/scripts/preflight.js
          echo "proxy_reachable=true" >> "$GITHUB_OUTPUT"
        continue-on-error: true

  # -------------------------------------------------------------------------
  # Domain interception tests
  # -------------------------------------------------------------------------
  test-domains:
    name: Domain Interception Tests
    runs-on: ubuntu-latest
    needs: preflight
    if: >
      always() &&
      (inputs.test_suite == 'all' || inputs.test_suite == 'domains' || inputs.test_suite == '')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: proxy-test-harness/package.json

      - name: Install dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Install Playwright browsers
        working-directory: proxy-test-harness
        run: npx playwright install chromium --with-deps

      - name: Create report directories
        run: |
          mkdir -p ${{ env.REPORTS_DIR }}
          mkdir -p ${{ env.ARTIFACTS_DIR }}/test-files

      - name: Run domain interception tests
        env:
          PROXY_HOST: ${{ inputs.proxy_host || secrets.PROXY_HOST || '127.0.0.1' }}
          PROXY_PORT: ${{ inputs.proxy_port || secrets.PROXY_PORT || '8080' }}
          PROXY_LOG_URL: ${{ secrets.PROXY_LOG_URL || 'http://localhost:3737/logs' }}
          PROXY_LOG_API_KEY: ${{ secrets.PROXY_LOG_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          CI: 'true'
        run: node tests/domain.test.js

      - name: Upload domain test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: domain-test-reports-${{ github.run_id }}
          path: reports/domain-test-*.json
          retention-days: 30
          if-no-files-found: warn

  # -------------------------------------------------------------------------
  # API interception tests
  # -------------------------------------------------------------------------
  test-api:
    name: API Interception Tests
    runs-on: ubuntu-latest
    needs: preflight
    if: >
      always() &&
      (inputs.test_suite == 'all' || inputs.test_suite == 'api' || inputs.test_suite == '')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: proxy-test-harness/package.json

      - name: Install dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Create report directories
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Run API interception tests
        env:
          PROXY_HOST: ${{ inputs.proxy_host || secrets.PROXY_HOST || '127.0.0.1' }}
          PROXY_PORT: ${{ inputs.proxy_port || secrets.PROXY_PORT || '8080' }}
          PROXY_LOG_URL: ${{ secrets.PROXY_LOG_URL || 'http://localhost:3737/logs' }}
          PROXY_LOG_API_KEY: ${{ secrets.PROXY_LOG_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          CI: 'true'
        run: node tests/api.test.js

      - name: Upload API test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-reports-${{ github.run_id }}
          path: reports/api-test-*.json
          retention-days: 30
          if-no-files-found: warn

  # -------------------------------------------------------------------------
  # Attachment deep inspection tests
  # -------------------------------------------------------------------------
  test-attachments:
    name: Attachment Deep Inspection Tests
    runs-on: ubuntu-latest
    needs: preflight
    if: >
      always() &&
      (inputs.test_suite == 'all' || inputs.test_suite == 'attachments' || inputs.test_suite == '')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: proxy-test-harness/package.json

      - name: Install system dependencies for canvas and OCR
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libc6 libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev \
            tesseract-ocr tesseract-ocr-eng \
            pkg-config build-essential

      - name: Install dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Install Playwright browsers
        working-directory: proxy-test-harness
        run: npx playwright install chromium --with-deps

      - name: Create artifact and report directories
        run: |
          mkdir -p ${{ env.REPORTS_DIR }}
          mkdir -p ${{ env.ARTIFACTS_DIR }}/test-files

      - name: Run attachment inspection tests
        env:
          PROXY_HOST: ${{ inputs.proxy_host || secrets.PROXY_HOST || '127.0.0.1' }}
          PROXY_PORT: ${{ inputs.proxy_port || secrets.PROXY_PORT || '8080' }}
          PROXY_LOG_URL: ${{ secrets.PROXY_LOG_URL || 'http://localhost:3737/logs' }}
          PROXY_LOG_API_KEY: ${{ secrets.PROXY_LOG_API_KEY }}
          CI: 'true'
        run: node tests/attachments.test.js

      - name: Upload attachment test report and files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attachment-test-reports-${{ github.run_id }}
          path: |
            reports/attachments-test-*.json
            artifacts/test-files/
          retention-days: 30
          if-no-files-found: warn

  # -------------------------------------------------------------------------
  # Bypass detection tests
  # -------------------------------------------------------------------------
  test-bypass:
    name: Bypass Attempt Tests
    runs-on: ubuntu-latest
    needs: preflight
    if: >
      always() &&
      (inputs.test_suite == 'all' || inputs.test_suite == 'bypass' || inputs.test_suite == '')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: proxy-test-harness/package.json

      - name: Install dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Create report directories
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Run bypass detection tests
        env:
          PROXY_HOST: ${{ inputs.proxy_host || secrets.PROXY_HOST || '127.0.0.1' }}
          PROXY_PORT: ${{ inputs.proxy_port || secrets.PROXY_PORT || '8080' }}
          PROXY_LOG_URL: ${{ secrets.PROXY_LOG_URL || 'http://localhost:3737/logs' }}
          PROXY_LOG_API_KEY: ${{ secrets.PROXY_LOG_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CI: 'true'
        run: node tests/bypass.test.js

      - name: Upload bypass test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bypass-test-reports-${{ github.run_id }}
          path: reports/bypass-test-*.json
          retention-days: 30
          if-no-files-found: warn

  # -------------------------------------------------------------------------
  # Endpoint discovery
  # -------------------------------------------------------------------------
  test-discovery:
    name: Endpoint Discovery
    runs-on: ubuntu-latest
    needs: preflight
    if: >
      always() &&
      (inputs.test_suite == 'all' || inputs.test_suite == 'discovery' || inputs.test_suite == '')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: proxy-test-harness/package.json

      - name: Install dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Create artifact and report directories
        run: |
          mkdir -p ${{ env.REPORTS_DIR }}
          mkdir -p ${{ env.ARTIFACTS_DIR }}

      - name: Run endpoint discovery
        env:
          PROXY_HOST: ${{ inputs.proxy_host || secrets.PROXY_HOST || '127.0.0.1' }}
          PROXY_PORT: ${{ inputs.proxy_port || secrets.PROXY_PORT || '8080' }}
          PROXY_LOG_URL: ${{ secrets.PROXY_LOG_URL || 'http://localhost:3737/logs' }}
          PROXY_LOG_API_KEY: ${{ secrets.PROXY_LOG_API_KEY }}
          CI: 'true'
        run: node tests/endpoint-discovery.js

      - name: Upload discovery artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: endpoint-discovery-${{ github.run_id }}
          path: |
            reports/endpoint-discovery-*.json
            artifacts/endpoint-registry.json
          retention-days: 90
          if-no-files-found: warn

  # -------------------------------------------------------------------------
  # Aggregate results and fail pipeline if any suite failed
  # -------------------------------------------------------------------------
  aggregate-and-report:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs:
      - test-domains
      - test-api
      - test-attachments
      - test-bypass
      - test-discovery
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install minimal dependencies
        working-directory: proxy-test-harness
        run: npm ci --prefer-offline || npm install

      - name: Download all test reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
          pattern: '*-reports-${{ github.run_id }}'
          merge-multiple: true

      - name: Aggregate reports
        id: aggregate
        run: |
          mkdir -p reports
          node proxy-test-harness/scripts/aggregate-reports.js
        continue-on-error: true

      - name: Upload aggregate report
        uses: actions/upload-artifact@v4
        with:
          name: aggregate-report-${{ github.run_id }}
          path: reports/aggregate-*.json
          retention-days: 90
          if-no-files-found: warn

      - name: Evaluate overall status
        run: |
          DOMAIN_RESULT="${{ needs.test-domains.result }}"
          API_RESULT="${{ needs.test-api.result }}"
          ATTACH_RESULT="${{ needs.test-attachments.result }}"
          BYPASS_RESULT="${{ needs.test-bypass.result }}"
          DISCOVERY_RESULT="${{ needs.test-discovery.result }}"

          echo "Domain test:      $DOMAIN_RESULT"
          echo "API test:         $API_RESULT"
          echo "Attachment test:  $ATTACH_RESULT"
          echo "Bypass test:      $BYPASS_RESULT"
          echo "Discovery:        $DISCOVERY_RESULT"

          FAILED=0
          for result in "$DOMAIN_RESULT" "$API_RESULT" "$ATTACH_RESULT" "$BYPASS_RESULT" "$DISCOVERY_RESULT"; do
            if [ "$result" = "failure" ]; then
              FAILED=$((FAILED + 1))
            fi
          done

          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED test suite(s) failed. Proxy validation FAILED."
            exit 1
          else
            echo "All test suites passed."
          fi

  # -------------------------------------------------------------------------
  # Notify on failure (optional â€” requires secrets)
  # -------------------------------------------------------------------------
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: aggregate-and-report
    if: failure() && secrets.SLACK_WEBHOOK_URL != ''
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": ":red_circle: *Complyze Proxy Validation FAILED*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":red_circle: *Complyze Proxy Validation Tests Failed*\n\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Results>\n*Branch:* `${{ github.ref_name }}`\n*Triggered by:* `${{ github.event_name }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
